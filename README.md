# Analysis for simultaneous Ephys recording and photometry imaging by pyPhotometry or SPAD.
## Pre-requisition
### Packages that used for open-ephys analysis
These packages are implemented in the analysis code, but you need to install or download them first.

To decode OpenEphys binary data, you need to install: 

https://github.com/open-ephys/open-ephys-python-tools

To process open-ephys LTP data, install pynapple:

**NOTE:** pynapple is somehow not compatible with the inbuild Spyder installater on Anaconda home page, i.e. if you create an environment for pynapple and want to use spyder, you have to use terminal to install and open Spyder (I'm not sure whether they've fixed this, my experience).

https://github.com/pynapple-org/pynapple

Pynacollada is used for ripple detection:

https://github.com/PeyracheLab/pynacollada#getting-started

https://github.com/PeyracheLab/pynacollada

https://github.com/PeyracheLab/pynacollada/tree/main/pynacollada/eeg_processing

### Analysing optical data
Before conducting analysis in this package, optical recordings should already be analysed; normalised signal, reference signal and zscore data should be saved as .csv files in the same file folder with behaviour tracking and the .pkl file generated by `EphyPreProcessing.py`.

I've put codes for processing both pyPhotometry and SPAD in this repository:
https://github.com/Yifang-Yuan/OptoEphysAnalysis/tree/main/SPADPhotometryAnalysis

With optical signal saved as a .csv file in the same folder as ephys results, you'll be able to proceed with the `CombineAnalysis.py`.

### Analysing behviour data
Behaviour data should also be analysed saved as .csv files with animals' coordinates in each camera frame.

Bonsai tracking and DeepLabCut can both be used to provide animal's coordinates. 


## Run order
`EphyPreProcessing.py`---use this file to call 'OpenEphysTools.py' to analysis Open Ephys data, using sync line to generate SPAD_mask and py_mask, save pickle file for each recording session.

`CombineAnalysis.py`---to create a class (`SyncOESPADSessionClass.py` or `SyncOECPySessionClass.py`) and analyse a session of data.  

`SyncOESPADSessionClass.py``SyncOECPySessionClass.py`--- Class with synchronised LFP,SPAD,cam data, no need to run, but it might need to be modified to achieve new functions and analysis. 

`OpenEphysTools.py`---including functions to decode the Open Ephys binary data, analysis LFP data and ripple detection, no need to run and change, unless you want to change the Open Ephys channels, band-pass filters for pre-processing, Sync pulse channels or other output signal channels. 
